name: E2E Tests

# This workflow runs ONLY on self-hosted runner
# Tests the COMPLETE flow: Create AKS cluster â†’ Create VM â†’ Register as flex node

on:
  # Manual trigger for E2E testing
  workflow_dispatch:
    inputs:
      skip_cleanup:
        description: 'Skip cleanup (keep cluster and VM for debugging)'
        required: false
        default: false
        type: boolean

  # Run on release tags
  push:
    tags:
      - 'v*'

  # Run on PRs - requires approval via environment protection
  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read

env:
  GO_VERSION: '1.24'

jobs:
  # ==========================================================================
  # Job 1: Build Binary
  # ==========================================================================
  build:
    name: Build Binary
    runs-on: [self-hosted, e2e, azure]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build binary for E2E testing
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Building aks-flex-node binary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VERSION="${GITHUB_REF_NAME:-dev}"
          GIT_COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "Version:    $VERSION"
          echo "Commit:     $GIT_COMMIT"
          echo "Build Date: $BUILD_DATE"
          echo ""

          LDFLAGS="-X main.Version=${VERSION} -X main.GitCommit=${GIT_COMMIT} -X main.BuildTime=${BUILD_DATE}"

          GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o aks-flex-node .
          chmod +x aks-flex-node

          echo "âœ… Binary built successfully"
          ./aks-flex-node version

      - name: Upload binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: aks-flex-node-binary
          path: aks-flex-node
          retention-days: 1

  # ==========================================================================
  # Job 2: Provision Infrastructure
  # ==========================================================================
  provision-infrastructure:
    name: Provision Infrastructure
    runs-on: [self-hosted, e2e, azure]
    needs: build
    timeout-minutes: 15
    outputs:
      cluster-name: ${{ steps.names.outputs.CLUSTER_NAME }}
      vm-name: ${{ steps.names.outputs.VM_NAME }}
      node-name: ${{ steps.names.outputs.NODE_NAME }}
      vm-ip: ${{ steps.provision-vm.outputs.VM_IP }}
      vm-msi: ${{ steps.provision-vm.outputs.VM_MSI }}
      cluster-id: ${{ steps.create-cluster.outputs.CLUSTER_ID }}

    steps:
      - name: Verify Azure Access
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Verifying Azure Authentication"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Testing Managed Identity authentication..."
          az account show --query "{Subscription:name, User:user.name}" -o table
          echo "âœ… Managed Identity works - no secrets needed!"

      - name: Generate unique test names
        id: names
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ·ï¸  Generating Test Resource Names"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          TIMESTAMP=$(date +%s)
          CLUSTER_NAME="aks-e2e-test-${TIMESTAMP}"
          VM_NAME="vm-e2e-test-${TIMESTAMP}"
          NODE_NAME="e2e-node-${TIMESTAMP}"

          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "VM_NAME=$VM_NAME" >> $GITHUB_OUTPUT
          echo "NODE_NAME=$NODE_NAME" >> $GITHUB_OUTPUT

          echo "Test Cluster: $CLUSTER_NAME"
          echo "Test VM:      $VM_NAME"
          echo "Node Name:    $NODE_NAME"
          echo ""
          echo "âœ… Names generated"

      - name: Create AKS cluster
        id: create-cluster
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜¸ï¸  Creating AKS Cluster"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          START_TIME=$(date +%s)
          CLUSTER_NAME="${{ steps.names.outputs.CLUSTER_NAME }}"

          echo "Creating cluster: $CLUSTER_NAME"
          echo "Location: ${{ secrets.E2E_LOCATION }}"
          echo ""

          az aks create \
            --resource-group ${{ secrets.E2E_RESOURCE_GROUP }} \
            --name $CLUSTER_NAME \
            --location ${{ secrets.E2E_LOCATION }} \
            --enable-managed-identity \
            --enable-aad \
            --enable-azure-rbac \
            --network-plugin azure \
            --node-count 1 \
            --node-vm-size Standard_B2s \
            --generate-ssh-keys \
            --tags "github-run=${{ github.run_id }}" "purpose=e2e-test" "auto-delete=true" \
            --output json > /tmp/cluster-info.json

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          # Get subscription ID dynamically from current context
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)

          # Construct resource ID
          CLUSTER_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${{ secrets.E2E_RESOURCE_GROUP }}/providers/Microsoft.ContainerService/managedClusters/$CLUSTER_NAME"
          echo "CLUSTER_ID=$CLUSTER_ID" >> $GITHUB_OUTPUT

          echo ""
          echo "âœ… AKS cluster created in ${DURATION}s"
          echo "Subscription ID: ${SUBSCRIPTION_ID}"
          echo "Resource Group: ${{ secrets.E2E_RESOURCE_GROUP }}"
          echo "Cluster Name: $CLUSTER_NAME"
          echo "Resource ID: $CLUSTER_ID"

          # Get cluster credentials
          echo ""
          echo "Configuring kubectl credentials..."
          az aks get-credentials \
            --resource-group ${{ secrets.E2E_RESOURCE_GROUP }} \
            --name $CLUSTER_NAME \
            --overwrite-existing \
            --admin

          echo "âœ… Cluster credentials configured"

      - name: Provision test VM with Managed Identity
        id: provision-vm
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ–¥ï¸  Provisioning Test VM"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          START_TIME=$(date +%s)
          VM_NAME="${{ steps.names.outputs.VM_NAME }}"

          echo "Creating VM: $VM_NAME"
          echo "Location: ${{ secrets.E2E_LOCATION }}"
          echo "Image: Ubuntu 22.04 LTS"
          echo ""

          az vm create \
            --resource-group ${{ secrets.E2E_RESOURCE_GROUP }} \
            --name $VM_NAME \
            --location ${{ secrets.E2E_LOCATION }} \
            --image Canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest \
            --size Standard_B2ms \
            --admin-username azureuser \
            --generate-ssh-keys \
            --public-ip-sku Standard \
            --assign-identity \
            --tags "github-run=${{ github.run_id }}" "purpose=e2e-test" "auto-delete=true" \
            --output json > /tmp/vm-info.json

          VM_IP=$(jq -r '.publicIpAddress' /tmp/vm-info.json)
          VM_MSI=$(jq -r '.identity.systemAssignedIdentity' /tmp/vm-info.json)

          echo "VM_IP=$VM_IP" >> $GITHUB_OUTPUT
          echo "VM_MSI=$VM_MSI" >> $GITHUB_OUTPUT

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo ""
          echo "âœ… VM created in ${DURATION}s"
          echo "IP Address: $VM_IP"
          echo "MSI Principal: $VM_MSI"

          # Wait for SSH
          echo ""
          echo "Waiting for SSH to be ready..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 azureuser@$VM_IP "echo ready" &>/dev/null; then
              echo "âœ… SSH ready after $i attempts"
              break
            fi
            echo "  Attempt $i/30..."
            sleep 10
          done

      - name: Save infrastructure info
        run: |
          mkdir -p /tmp/e2e-artifacts

          cat > /tmp/e2e-artifacts/infrastructure.json <<EOF
          {
            "cluster_name": "${{ steps.names.outputs.CLUSTER_NAME }}",
            "vm_name": "${{ steps.names.outputs.VM_NAME }}",
            "node_name": "${{ steps.names.outputs.NODE_NAME }}",
            "vm_ip": "${{ steps.provision-vm.outputs.VM_IP }}",
            "vm_msi": "${{ steps.provision-vm.outputs.VM_MSI }}",
            "cluster_id": "${{ steps.create-cluster.outputs.CLUSTER_ID }}",
            "subscription_id": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenant_id": "${{ secrets.AZURE_TENANT_ID }}",
            "resource_group": "${{ secrets.E2E_RESOURCE_GROUP }}",
            "location": "${{ secrets.E2E_LOCATION }}"
          }
          EOF

          echo "âœ… Infrastructure info saved"

      - name: Upload infrastructure info
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-info
          path: /tmp/e2e-artifacts/infrastructure.json
          retention-days: 1

  # ==========================================================================
  # Job 3: Grant Permissions
  # ==========================================================================
  grant-permissions:
    name: Grant Permissions
    runs-on: [self-hosted, e2e, azure]
    needs: provision-infrastructure
    timeout-minutes: 5

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info
          path: /tmp/

      - name: Wait for VM MSI replication
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â³ Waiting for MSI Replication"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VM_MSI="${{ needs.provision-infrastructure.outputs.vm-msi }}"
          VM_NAME="${{ needs.provision-infrastructure.outputs.vm-name }}"

          echo "VM:              $VM_NAME"
          echo "MSI Principal:   $VM_MSI"
          echo ""

          # Wait for MSI replication in Azure AD
          # Azure AD replication can take 5-60 seconds
          echo "Waiting 30s for MSI replication in Azure AD..."
          sleep 30
          echo "âœ… MSI should be replicated"

      - name: Grant VM MSI permissions to AKS cluster
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”‘ Granting AKS Cluster Access Permissions to VM MSI"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Read infrastructure info from artifact
          INFRA=$(cat /tmp/infrastructure.json)
          VM_MSI=$(echo $INFRA | jq -r '.vm_msi')
          CLUSTER_ID=$(echo $INFRA | jq -r '.cluster_id')
          CLUSTER_NAME=$(echo $INFRA | jq -r '.cluster_name')

          echo "VM MSI:          $VM_MSI"
          echo "Cluster:         $CLUSTER_NAME"
          echo "Cluster ID:      $CLUSTER_ID"
          echo ""

          echo "[1/2] Granting 'Azure Kubernetes Service Cluster Admin Role'..."
          az role assignment create \
            --assignee-object-id $VM_MSI \
            --assignee-principal-type ServicePrincipal \
            --role "Azure Kubernetes Service Cluster Admin Role" \
            --scope "$CLUSTER_ID" \
            --output none

          echo "âœ… Cluster Admin Role granted"

          echo "[2/2] Granting 'Azure Kubernetes Service RBAC Cluster Admin'..."
          az role assignment create \
            --assignee-object-id $VM_MSI \
            --assignee-principal-type ServicePrincipal \
            --role "Azure Kubernetes Service RBAC Cluster Admin" \
            --scope "$CLUSTER_ID" \
            --output none

          echo "âœ… RBAC Cluster Admin Role granted"
          echo ""
          echo "Waiting 15s for permission propagation..."
          sleep 15
          echo "âœ… AKS cluster permissions ready"

      - name: Setup Azure CLI on VM
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš™ï¸  Configuring Azure CLI on VM"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VM_IP="${{ needs.provision-infrastructure.outputs.vm-ip }}"

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP 'bash -s' <<'REMOTE'
          set -euo pipefail

          echo "[1/3] Installing Azure CLI..."
          # Update package lists first
          sudo apt-get update -qq

          # Install Azure CLI with verbose error output
          if ! curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash; then
            echo "âŒ Azure CLI installation failed"
            exit 1
          fi

          echo "[2/3] Login azureuser with Managed Identity..."
          if ! az login --identity --output none; then
            echo "âŒ Failed to login with managed identity as azureuser"
            echo "Checking MSI endpoint..."
            curl -H "Metadata: true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" || echo "MSI endpoint not responding"
            exit 1
          fi

          echo "[3/3] Login root with Managed Identity..."
          if ! sudo az login --identity --output none; then
            echo "âŒ Failed to login with managed identity as root"
            exit 1
          fi

          echo ""
          echo "âœ… Azure CLI configured with MSI"
          echo ""
          echo "azureuser context:"
          az account show --query "{Subscription:name, User:user.name}" -o table
          echo ""
          echo "root context:"
          sudo az account show --query "{Subscription:name, User:user.name}" -o table
          REMOTE

          echo ""
          echo "âœ… Azure CLI setup complete"

  # ==========================================================================
  # Job 4: Bootstrap Flex Node
  # ==========================================================================
  bootstrap-flex-node:
    name: Bootstrap Flex Node
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, grant-permissions]
    timeout-minutes: 15

    steps:
      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: aks-flex-node-binary
          path: /tmp/

      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info
          path: /tmp/

      - name: Prepare bootstrap config
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Generating Bootstrap Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Load infrastructure info
          INFRA=$(cat /tmp/infrastructure.json)
          CLUSTER_ID=$(echo $INFRA | jq -r '.cluster_id')
          NODE_NAME=$(echo $INFRA | jq -r '.node_name')
          CLUSTER_NAME=$(echo $INFRA | jq -r '.cluster_name')
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')
          SUBSCRIPTION_ID=$(echo $INFRA | jq -r '.subscription_id')
          TENANT_ID=$(echo $INFRA | jq -r '.tenant_id')
          RESOURCE_GROUP=$(echo $INFRA | jq -r '.resource_group')
          LOCATION=$(echo $INFRA | jq -r '.location')

          echo "Cluster:  $CLUSTER_NAME"
          echo "VM:       $VM_NAME"
          echo "Node:     $NODE_NAME"
          echo ""

          cat > /tmp/config.json <<EOF
          {
            "azure": {
              "subscriptionId": "$SUBSCRIPTION_ID",
              "tenantId": "$TENANT_ID",
              "cloud": "AzurePublicCloud",
              "managedIdentity": {},
              "targetCluster": {
                "resourceId": "$CLUSTER_ID",
                "location": "$LOCATION"
              }
            },
            "agent": {
              "logLevel": "debug",
              "logDir": "/var/log/aks-flex-node"
            },
            "kubernetes": {
              "version": "1.35.0"
            },
            "containerd": {
              "version": "1.7.13"
            },
            "runc": {
              "version": "1.1.12"
            }
          }
          EOF

          echo "âœ… Configuration generated (using VM's system-assigned MSI)"

      - name: Upload files to VM
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ Uploading Files to VM"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VM_IP="${{ needs.provision-infrastructure.outputs.vm-ip }}"

          chmod +x /tmp/aks-flex-node

          echo "Uploading binary..."
          scp -o StrictHostKeyChecking=no /tmp/aks-flex-node azureuser@$VM_IP:/tmp/aks-flex-node-binary

          echo "Uploading config..."
          scp -o StrictHostKeyChecking=no /tmp/config.json azureuser@$VM_IP:/tmp/

          echo "âœ… Files uploaded to $VM_IP"

      - name: Run bootstrap
        id: bootstrap
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Running Bootstrap on VM"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VM_IP="${{ needs.provision-infrastructure.outputs.vm-ip }}"
          START_TIME=$(date +%s)

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP 'bash -s' <<'BOOTSTRAP_TEST'
          set -euo pipefail

          echo "[1/5] Installing aks-flex-node binary..."
          sudo cp /tmp/aks-flex-node-binary /usr/local/bin/aks-flex-node
          sudo chmod +x /usr/local/bin/aks-flex-node
          aks-flex-node version
          echo ""

          echo "[2/5] Setting up configuration..."
          sudo mkdir -p /etc/aks-flex-node
          sudo cp /tmp/config.json /etc/aks-flex-node/
          sudo mkdir -p /var/log/aks-flex-node
          echo ""

          echo "[3/5] Running agent (bootstrap)..."
          # Run agent as a transient systemd service so it persists after SSH session ends
          sudo systemd-run \
            --unit=aks-flex-node-e2e \
            --description="AKS Flex Node E2E Test" \
            --remain-after-exit \
            /usr/local/bin/aks-flex-node agent --config /etc/aks-flex-node/config.json

          echo "Agent started as systemd unit: aks-flex-node-e2e"
          echo ""

          # Wait for bootstrap to complete
          echo "Waiting 60s for bootstrap process..."
          sleep 60

          # Check if agent is still running
          if systemctl is-active --quiet aks-flex-node-e2e; then
            echo "âœ… Agent is running"
            sudo systemctl status aks-flex-node-e2e --no-pager -l | head -n 10
          else
            echo "âŒ Agent exited unexpectedly"
            echo ""
            echo "Systemd unit status:"
            sudo systemctl status aks-flex-node-e2e --no-pager -l || true
            echo ""
            echo "Last 50 lines of log:"
            sudo tail -n 50 /var/log/aks-flex-node/aks-flex-node.log
            exit 1
          fi
          echo ""

          echo "[4/5] Verifying kubelet..."
          sleep 10  # Wait for kubelet to start
          if systemctl is-active --quiet kubelet; then
            echo "âœ… kubelet is running"
            systemctl status kubelet --no-pager -l | head -n 10
          else
            echo "âš ï¸  kubelet not running yet, checking status..."
            systemctl status kubelet --no-pager -l || true
          fi

          echo "[5/5] Verifying node registration..."
          echo "Node should appear in cluster within a few minutes"
          BOOTSTRAP_TEST

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Bootstrap completed in ${DURATION}s"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ==========================================================================
  # Job 5: Verify Integration
  # ==========================================================================
  verify-integration:
    name: Verify Integration
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, grant-permissions, bootstrap-flex-node]
    if: always() && needs.bootstrap-flex-node.result == 'success'
    timeout-minutes: 10

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info
          path: /tmp/

      - name: Verify node joined AKS cluster
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜¸ï¸  Verifying Node Joined Cluster"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')
          CLUSTER_NAME=$(echo $INFRA | jq -r '.cluster_name')
          RESOURCE_GROUP=$(echo $INFRA | jq -r '.resource_group')

          echo "Checking for node: $VM_NAME"
          echo "In cluster: $CLUSTER_NAME"
          echo ""

          # Get cluster credentials
          az aks get-credentials \
            --resource-group $RESOURCE_GROUP \
            --name $CLUSTER_NAME \
            --overwrite-existing \
            --admin

          # Wait for node to join
          echo "Waiting for node to appear in cluster..."
          for i in {1..30}; do
            if kubectl get nodes | grep -q "$VM_NAME"; then
              echo ""
              echo "âœ… Node successfully joined cluster"
              echo ""
              kubectl get nodes
              echo ""
              kubectl get node $VM_NAME -o wide
              exit 0
            fi
            echo "  Waiting... ($i/30)"
            sleep 10
          done

          echo ""
          echo "âŒ Node did not join cluster within timeout"
          echo ""
          echo "Current nodes in cluster:"
          kubectl get nodes
          exit 1

      - name: Run smoke test
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Running Smoke Test"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')

          echo "Deploying test pod to flex node..."

          cat > /tmp/test-pod.yaml <<EOF
          apiVersion: v1
          kind: Pod
          metadata:
            name: e2e-smoke-test
          spec:
            nodeSelector:
              kubernetes.io/hostname: $VM_NAME
            containers:
            - name: nginx
              image: nginx:alpine
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "100m"
                limits:
                  memory: "128Mi"
                  cpu: "200m"
          EOF

          kubectl apply -f /tmp/test-pod.yaml

          echo ""
          echo "Waiting for pod to be ready..."
          if kubectl wait --for=condition=Ready pod/e2e-smoke-test --timeout=120s; then
            echo ""
            echo "âœ… Smoke test PASSED"
            echo ""
            kubectl get pod e2e-smoke-test -o wide

            # Cleanup
            kubectl delete pod e2e-smoke-test
          else
            echo ""
            echo "âŒ Smoke test FAILED"
            echo ""
            kubectl describe pod e2e-smoke-test
            exit 1
          fi

  # ==========================================================================
  # Job 6: Collect Logs (Always Runs)
  # ==========================================================================
  collect-logs:
    name: Collect Logs
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, grant-permissions, bootstrap-flex-node]
    if: always() && needs.provision-infrastructure.result == 'success'
    timeout-minutes: 5

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info
          path: /tmp/

      - name: Collect logs from VM
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Collecting Logs"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          mkdir -p /tmp/e2e-logs

          INFRA=$(cat /tmp/infrastructure.json)
          VM_IP=$(echo $INFRA | jq -r '.vm_ip')

          echo "Collecting logs from VM: $VM_IP"
          echo ""

          echo "[1/5] aks-flex-node.log"
          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo cat /var/log/aks-flex-node/aks-flex-node.log 2>/dev/null" \
            > /tmp/e2e-logs/aks-flex-node.log || echo "âš ï¸  No aks-flex-node log"

          echo "[2/5] aks-flex-node-e2e systemd unit log"
          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo journalctl -u aks-flex-node-e2e -n 200 --no-pager 2>/dev/null" \
            > /tmp/e2e-logs/aks-flex-node-e2e.log || echo "âš ï¸  No systemd unit log"

          echo "[3/5] kubelet.log"
          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo journalctl -u kubelet -n 200 --no-pager 2>/dev/null" \
            > /tmp/e2e-logs/kubelet.log || echo "âš ï¸  No kubelet log"

          echo "[4/5] containerd.log"
          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo journalctl -u containerd -n 100 --no-pager 2>/dev/null" \
            > /tmp/e2e-logs/containerd.log || echo "âš ï¸  No containerd log"

          echo "[5/5] VM system info"
          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo systemctl list-units --type=service --state=running | grep -E 'kubelet|containerd|aks-flex' || true" \
            > /tmp/e2e-logs/running-services.log || echo "âš ï¸  No service info"

          echo ""
          echo "âœ… Logs collected"

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-logs-${{ github.run_id }}
          path: /tmp/e2e-logs/
          retention-days: 7

  # ==========================================================================
  # Job 7: Cleanup Resources (Always Runs)
  # ==========================================================================
  cleanup:
    name: Cleanup Resources
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, grant-permissions, bootstrap-flex-node, verify-integration, collect-logs]
    if: always() && needs.provision-infrastructure.result == 'success' && !inputs.skip_cleanup
    timeout-minutes: 10

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info
          path: /tmp/

      - name: Cleanup test resources
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§¹ Cleaning Up E2E Test Resources"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          CLUSTER_NAME=$(echo $INFRA | jq -r '.cluster_name')
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')
          NODE_NAME=$(echo $INFRA | jq -r '.node_name')
          RESOURCE_GROUP=$(echo $INFRA | jq -r '.resource_group')

          echo ""
          echo "Strategy: Delete VM with --force-deletion, then cleanup by tags"
          echo ""
          echo "Resources to clean up:"
          echo "  Cluster: $CLUSTER_NAME"
          echo "  VM:      $VM_NAME"
          echo "  Node:    $NODE_NAME"
          echo "  Tagged:  github-run=${{ github.run_id }}"
          echo ""

          # Step 1: Force delete VM (attempts to delete associated resources)
          echo "[1/3] Force deleting VM and attempting cleanup of associated resources..."
          START_TIME=$(date +%s)
          az vm delete \
            --resource-group $RESOURCE_GROUP \
            --name "$VM_NAME" \
            --force-deletion yes \
            --yes \
            --no-wait \
            || echo "âš ï¸  VM deletion failed (may not exist)"
          END_TIME=$(date +%s)
          echo "âœ… VM force deletion initiated ($((END_TIME - START_TIME))s)"

          # Step 2: Delete any remaining resources by tags (catches orphaned resources)
          # IMPORTANT: Only delete resources created by THIS workflow run
          echo ""
          echo "[2/3] Cleaning up remaining tagged resources in dependency order..."
          START_TIME=$(date +%s)

          # Delete resources in proper dependency order to avoid conflicts
          # Order: NIC â†’ Public IP â†’ NSG â†’ Disk

          echo "Deleting NICs..."
          az resource list \
            --resource-group $RESOURCE_GROUP \
            --query "[?tags.\"github-run\"=='${{ github.run_id }}' && tags.purpose=='e2e-test' && type=='Microsoft.Network/networkInterfaces'].id" \
            -o tsv | while read -r resource_id; do
              echo "  Deleting NIC: $resource_id"
              az resource delete --ids "$resource_id" --no-wait 2>/dev/null || echo "    âš ï¸  Failed"
            done

          # Wait a bit for NICs to start deleting
          sleep 5

          echo "Deleting Public IPs..."
          az resource list \
            --resource-group $RESOURCE_GROUP \
            --query "[?tags.\"github-run\"=='${{ github.run_id }}' && tags.purpose=='e2e-test' && type=='Microsoft.Network/publicIPAddresses'].id" \
            -o tsv | while read -r resource_id; do
              echo "  Deleting Public IP: $resource_id"
              az resource delete --ids "$resource_id" --no-wait 2>/dev/null || echo "    âš ï¸  Failed"
            done

          echo "Deleting NSGs..."
          az resource list \
            --resource-group $RESOURCE_GROUP \
            --query "[?tags.\"github-run\"=='${{ github.run_id }}' && tags.purpose=='e2e-test' && type=='Microsoft.Network/networkSecurityGroups'].id" \
            -o tsv | while read -r resource_id; do
              echo "  Deleting NSG: $resource_id"
              az resource delete --ids "$resource_id" --no-wait 2>/dev/null || echo "    âš ï¸  Failed"
            done

          echo "Deleting Disks..."
          az resource list \
            --resource-group $RESOURCE_GROUP \
            --query "[?tags.\"github-run\"=='${{ github.run_id }}' && tags.purpose=='e2e-test' && type=='Microsoft.Compute/disks'].id" \
            -o tsv | while read -r resource_id; do
              echo "  Deleting Disk: $resource_id"
              az resource delete --ids "$resource_id" --no-wait 2>/dev/null || echo "    âš ï¸  Failed"
            done

          END_TIME=$(date +%s)
          echo "âœ… Tagged resource cleanup completed ($((END_TIME - START_TIME))s)"

          # Step 3: Cleanup AKS cluster
          echo ""
          echo "[3/3] Cleaning up AKS cluster..."

          # AKS cleanup
          START_TIME=$(date +%s)
          az aks delete \
            --resource-group $RESOURCE_GROUP \
            --name "$CLUSTER_NAME" \
            --yes \
            --no-wait \
            2>/dev/null || echo "âš ï¸  Cluster cleanup failed (may not exist)"
          echo "âœ… AKS cluster cleanup initiated ($(($(date +%s) - START_TIME))s)"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Cleanup Completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Cleanup strategy:"
          echo "  1. âœ“ VM with --force-deletion (attempts to delete disk, NIC, etc)"
          echo "  2. âœ“ Tag-based cleanup (catches any orphaned resources)"
          echo "  3. âœ“ AKS cluster"
          echo ""
          echo "Note: Resources are being deleted in the background (--no-wait)"
          echo "Deletion may take 5-10 minutes to complete in Azure"

  # ==========================================================================
  # Job 8: Test Summary (Always Runs)
  # ==========================================================================
  summary:
    name: Test Summary
    runs-on: [self-hosted, e2e, azure]
    needs: [build, provision-infrastructure, grant-permissions, bootstrap-flex-node, verify-integration]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Generate test summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š E2E Test Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Job Results:"
          echo "  Build:                ${{ needs.build.result }}"
          echo "  Provision:            ${{ needs.provision-infrastructure.result }}"
          echo "  Grant Permissions:    ${{ needs.grant-permissions.result }}"
          echo "  Bootstrap:            ${{ needs.bootstrap-flex-node.result }}"
          echo "  Verify Integration:   ${{ needs.verify-integration.result }}"
          echo ""

          if [ "${{ needs.provision-infrastructure.result }}" == "success" ]; then
            echo "Test Resources:"
            echo "  Cluster: ${{ needs.provision-infrastructure.outputs.cluster-name }}"
            echo "  VM:      ${{ needs.provision-infrastructure.outputs.vm-name }}"
            echo "  Node:    ${{ needs.provision-infrastructure.outputs.node-name }}"
            echo ""
          fi

          echo "Artifacts:"
          echo "  Logs: e2e-logs-${{ github.run_id }}"
          echo ""

          # Determine overall status
          if [ "${{ needs.grant-permissions.result }}" == "success" ] && \
             [ "${{ needs.bootstrap-flex-node.result }}" == "success" ] && \
             [ "${{ needs.verify-integration.result }}" == "success" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… E2E Test PASSED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "The aks-flex-node successfully:"
            echo "  âœ… Built binary"
            echo "  âœ… Created fresh AKS cluster"
            echo "  âœ… Created test VM with Managed Identity"
            echo "  âœ… Granted AKS cluster access to VM's MSI"
            echo "  âœ… Configured kubelet and containerd (using VM's MSI)"
            echo "  âœ… Joined the VM as flex node to AKS cluster"
            echo "  âœ… Passed smoke test"
            echo ""
            exit 0
          else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ E2E Test FAILED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Check the uploaded logs for details:"
            echo "  Actions â†’ This run â†’ Artifacts â†’ e2e-logs-${{ github.run_id }}"
            echo ""
            exit 1
          fi
